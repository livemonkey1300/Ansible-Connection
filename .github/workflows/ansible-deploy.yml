name: Ansible Deploy

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      playbook:
        description: 'Playbook to run'
        required: false
        default: 'playbook/test.yml'

jobs:
  ansible-lint:
    runs-on: ubuntu-latest
    name: Lint Ansible Files
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install ansible ansible-lint yamllint

    - name: Lint YAML files
      run: |
        yamllint -d relaxed .

    - name: Lint Ansible playbooks
      run: |
        ansible-lint playbook/ || true

    - name: Validate inventory
      run: |
        chmod +x inventory/generate_inventory.py
        ansible-inventory --list -i inventory/generate_inventory.py

  ansible-deploy:
    runs-on: ubuntu-latest
    needs: ansible-lint
    name: Deploy with Ansible
    
    environment: 
      name: ${{ github.event.inputs.environment || 'staging' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Ansible
      run: |
        python -m pip install --upgrade pip
        pip install ansible

    - name: Setup SSH Agent
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.ANSIBLE_SSH_PRIVATE_KEY }}

    - name: Add SSH known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.TARGET_HOST }} >> ~/.ssh/known_hosts || true

    - name: Make inventory executable
      run: |
        chmod +x inventory/generate_inventory.py

    - name: Test Ansible connectivity
      run: |
        ansible all -m ping -i inventory/generate_inventory.py

    - name: Run Ansible Playbook (Dry Run)
      if: github.event_name == 'pull_request'
      run: |
        playbook="${{ github.event.inputs.playbook || 'playbook/test.yml' }}"
        ansible-playbook -i inventory/generate_inventory.py "$playbook" --check --diff

    - name: Run Ansible Playbook
      if: github.event_name != 'pull_request'
      run: |
        playbook="${{ github.event.inputs.playbook || 'playbook/test.yml' }}"
        ansible-playbook -i inventory/generate_inventory.py "$playbook"

    - name: Upload Ansible logs
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: ansible-logs
        path: ansible.log
        retention-days: 30

  security-check:
    runs-on: ubuntu-latest
    name: Security Checks
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'